# Chrysalis项目状态报告

## ✅ 已完成的工作

### 1. 项目基础搭建
- ✅ 从Scarab复制完整代码库到Chrysalis目录
- ✅ 重命名所有项目文件
  - `Scarab.sln` → `Chrysalis.sln`
  - `Scarab/` → `Chrysalis-Main/`
  - `Scarab.Tests/` → `Chrysalis.Tests/`
  - `Scarab.csproj` → `Chrysalis.csproj`

### 2. 命名空间批量替换
- ✅ 所有.cs文件的命名空间: `Scarab` → `Chrysalis`
- ✅ 所有using语句更新
- ✅ XAML文件中的命名空间引用更新
- ✅ 共更新约50+个文件

### 3. 游戏路径适配
- ✅ `Settings.cs` 更新游戏路径检测
  - Steam路径: `Hollow Knight Silksong`
  - 配置文件路径: `SilksongModManager/ChrysalisSettings.json`
- ✅ `PathUtil.cs` 更新目录后缀
  - `Hollow Knight Silksong_Data/Managed`
  - BepInEx路径检测
- ✅ 可执行文件名称更新
  - `Hollow Knight Silksong.exe`

### 4. 核心配置文件创建
- ✅ `GameConfig.cs` - 集中管理游戏相关配置
  - Steam AppID: 1030300
  - BepInEx相关常量
  - 路径辅助方法

### 5. 项目配置更新
- ✅ `Chrysalis.csproj`:
  - 版本号: 1.0.0.0
  - 命名空间: Chrysalis
  - 图标引用: `chrysalis.ico`
- ✅ 解决方案文件路径更新

### 6. 文档创建
- ✅ `README.md` - 项目说明和使用指南
- ✅ `ModLinks仓库建立和提交规范.md` - 详细的ModLinks仓库教程
- ✅ `UI资源缺省列表.md` - 完整的资源清单
- ✅ `项目状态和下一步.md` - 本文档

---

## ⚠️ 需要注意的事项

### 游戏尚未发布
以下配置基于推测，需要在游戏发布后验证：

1. **目录结构**
   - Unity Data目录名称：`Hollow Knight Silksong_Data`（待确认）
   - 可执行文件名：`Hollow Knight Silksong.exe`（待确认）
   - Assembly文件名：可能仍是`Assembly-CSharp.dll`

2. **BepInEx集成**
   - 当前代码仍保留原Modding API逻辑
   - 需要大幅修改`Installer.cs`以适配BepInEx
   - Mod安装位置改为`BepInEx/plugins/`

3. **ModLinks数据源**
   - 当前URL仍指向占位符
   - 需要实际建立GitHub仓库
   - 需要与社区协调维护

---

## 🔴 优先级任务

### 第一优先级：立即可做

#### 1. 创建应用图标
**位置**: `Chrysalis-Main/Assets/chrysalis.ico`

**要求**:
- 蛹/茧/蝴蝶主题
- 暗红色系 (#6E1503, #E91E63)
- 尺寸: 16x16, 32x32, 48x48, 256x256

**工具**:
- 设计：Figma / Inkscape
- 转换：https://convertico.com/

#### 2. 更新配色方案
**文件**: `Chrysalis-Main/App.xaml`

**操作**:
```xml
<!-- 找到<Application.Resources>部分 -->
<!-- 更新以下颜色 -->
<Color x:Key="PrimaryColor">#6E1503</Color>
<Color x:Key="SecondaryColor">#E91E63</Color>
<Color x:Key="AccentColor">#E91E63</Color>
```

#### 3. 更新文本资源
**文件**: 
- `Chrysalis-Main/Resources.resx`（英文）
- `Chrysalis-Main/Resources.zh.resx`（中文）

**关键更新**:
| 资源键 | 旧值 | 新值（英文） | 新值（中文） |
|--------|------|------------|------------|
| App_Name | Scarab | Chrysalis | 蛹 |
| Game_Name | Hollow Knight | Hollow Knight: Silksong | 空洞骑士：丝之歌 |
| API_Name | Modding API | BepInEx | BepInEx |

---

### 第二优先级：游戏发布前准备

#### 4. 重构Installer.cs以支持BepInEx

当前`Installer.cs`的逻辑是：
```
1. 下载Modding API
2. 备份Assembly-CSharp.dll (.v原版)
3. 替换为修改版 (.m)
4. 在Mods/目录安装Mod
```

需要改为BepInEx逻辑：
```
1. 检测BepInEx是否安装
2. 如未安装，下载BepInEx并解压到游戏根目录
3. 启动游戏一次以生成config和plugins目录
4. 将Mod安装到BepInEx/plugins/目录
5. 无需修改Assembly-CSharp.dll
```

**修改建议**:

创建新文件 `BepInExInstaller.cs`:
```csharp
namespace Chrysalis.Services;

public class BepInExInstaller
{
    public async Task InstallBepInEx(string gameRoot)
    {
        // 1. 下载BepInEx
        // 2. 解压到游戏根目录
        // 3. 验证安装
    }
    
    public bool IsBepInExInstalled(string gameRoot)
    {
        return GameConfig.IsBepInExInstalled(gameRoot);
    }
}
```

修改 `Installer.cs`:
```csharp
public async Task Install(ModItem mod, ...)
{
    // 移除API安装逻辑
    // await InstallApi();  // 删除此行
    
    // 添加BepInEx检查
    if (!_bepInEx.IsBepInExInstalled(_config.GameRoot))
    {
        await _bepInEx.InstallBepInEx(_config.GameRoot);
    }
    
    // Mod安装到BepInEx/plugins/
    string pluginsFolder = GameConfig.GetBepInExPluginsPath(_config.GameRoot);
    // ... 安装逻辑
}
```

**移除的功能**:
- `InstallApi()` 方法
- `ToggleApi()` 方法
- Assembly备份逻辑 (.v, .m文件)

**新增的功能**:
- BepInEx安装检测
- BepInEx自动安装
- 提示用户首次运行游戏

#### 5. 更新ISettings接口

**文件**: `Chrysalis-Main/Interfaces/ISettings.cs`

添加新属性：
```csharp
public interface ISettings
{
    // 现有属性...
    string ManagedFolder { get; set; }
    
    // 新增属性
    string GameRoot { get; }  // 游戏根目录
    string BepInExFolder { get; } // BepInEx目录
    string PluginsFolder { get; } // Plugins目录
    string DisabledFolder { get; } // 禁用的Mod目录
    
    // 移除
    // string ModsFolder { get; } // 不再使用Mods/目录
}
```

**实现** (`Settings.cs`):
```csharp
public string GameRoot => Path.GetFullPath(Path.Combine(ManagedFolder, "..", ".."));

public string BepInExFolder => Path.Combine(GameRoot, "BepInEx");

public string PluginsFolder => Path.Combine(BepInExFolder, "plugins");

public string DisabledFolder => Path.Combine(PluginsFolder, "_Disabled");
```

#### 6. 创建ModLinks仓库

**仓库名**: `silksong-modlinks`

**步骤**:
1. 在GitHub创建公开仓库
2. 添加`ModLinks.xml`和`ApiLinks.xml`
3. 添加`.github/workflows/validate-xml.yml`
4. 添加`CONTRIBUTING.md`
5. 设置分支保护规则

**更新代码**:

`Chrysalis-Main/Services/ModDatabase.cs`:
```csharp
// 更新URL
private const string MODLINKS_URI = "https://raw.githubusercontent.com/YOUR_ORG/silksong-modlinks/main/ModLinks.xml";
private const string APILINKS_URI = "https://raw.githubusercontent.com/YOUR_ORG/silksong-modlinks/main/ApiLinks.xml";

private const string FALLBACK_MODLINKS_URI = "https://cdn.jsdelivr.net/gh/YOUR_ORG/silksong-modlinks@latest/ModLinks.xml";
private const string FALLBACK_APILINKS_URI = "https://cdn.jsdelivr.net/gh/YOUR_ORG/silksong-modlinks@latest/ApiLinks.xml";
```

---

### 第三优先级：游戏发布后立即执行

#### 7. 验证和修正游戏路径

**任务**:
1. 获取游戏实际安装路径
2. 确认Unity Data目录名称
3. 确认可执行文件名称
4. 更新`Settings.cs`和`PathUtil.cs`中的路径

#### 8. 测试BepInEx安装

**任务**:
1. 手动安装BepInEx
2. 验证目录结构
3. 测试Mod加载
4. 调试安装器逻辑

#### 9. 发布Alpha版本

**检查清单**:
- [ ] 应用图标已创建
- [ ] 配色已更新
- [ ] 游戏路径正确
- [ ] BepInEx安装正常
- [ ] 至少可安装1个测试Mod
- [ ] 基本UI可用
- [ ] 无严重崩溃

---

## 📋 完整待办清单

### 立即可做（不依赖游戏发布）

- [ ] **创建应用图标** (`chrysalis.ico`, `chrysalis.png`, `Chrysalis.icns`)
- [ ] **更新App.xaml配色方案** (暗红色系)
- [ ] **更新Resources.resx文本资源** (英文)
- [ ] **更新Resources.zh.resx文本资源** (中文)
- [ ] **创建Logo** (关于页面用)
- [ ] **创建状态图标** (已安装/未安装/更新)
- [ ] **重构Installer.cs** (移除API逻辑，添加BepInEx)
- [ ] **创建BepInExInstaller.cs**
- [ ] **更新ISettings接口** (添加BepInEx路径)
- [ ] **建立ModLinks GitHub仓库**
- [ ] **编写单元测试** (路径检测、BepInEx安装)
- [ ] **更新About页面** (新的项目信息)
- [ ] **移除GOG注册表检测** (丝之歌可能不在GOG发售)

### 等待游戏发布

- [ ] **确认游戏目录结构**
- [ ] **确认可执行文件名**
- [ ] **确认Unity版本**
- [ ] **测试BepInEx兼容性**
- [ ] **验证Steam路径检测**
- [ ] **测试实际Mod安装**

### 长期维护

- [ ] **建立CI/CD流程** (GitHub Actions)
- [ ] **添加自动更新功能**
- [ ] **创建用户文档**
- [ ] **建立社区Discord/QQ群**
- [ ] **收集用户反馈**
- [ ] **持续更新ModLinks**

---

## 🛠️ 开发环境配置

### 必需软件
1. **Visual Studio 2022** 或 **JetBrains Rider**
2. **.NET 8.0 SDK**
3. **Git**

### 编译项目
```bash
cd C:\Users\StarDream\Desktop\Coding\Webbing\Chrysalis
dotnet restore
dotnet build
```

### 运行项目
```bash
cd Chrysalis-Main
dotnet run
```

### 发布版本
```powershell
# Windows x64
dotnet publish -c Release -r win-x64 --self-contained

# Linux x64
dotnet publish -c Release -r linux-x64 --self-contained

# macOS (Apple Silicon)
dotnet publish -c Release -r osx-arm64 --self-contained
```

---

## 📊 项目进度估计

### 当前进度: 约30%

**已完成**:
- ✅ 项目框架搭建 (100%)
- ✅ 命名空间重命名 (100%)
- ✅ 游戏路径适配 (80%) - 需游戏发布后验证
- ✅ 文档准备 (100%)

**进行中**:
- 🔄 UI资源创建 (0%)
- 🔄 BepInEx集成 (10%)
- 🔄 ModLinks仓库 (0%)

**未开始**:
- ⏳ 测试和调试 (0%)
- ⏳ 发布准备 (0%)
- ⏳ 社区建设 (0%)

### 预计时间表

**第1周** (当前):
- 创建应用图标
- 更新UI配色
- 更新文本资源
- 重构Installer

**第2-3周**:
- 完成BepInEx集成
- 建立ModLinks仓库
- 编写测试

**游戏发布日**:
- 紧急适配游戏路径
- 验证功能
- 发布Alpha 0.1

**发布后1周**:
- 收集反馈
- 修复Bug
- 发布Beta 0.5

**发布后1个月**:
- 功能完善
- 发布1.0正式版

---

## 🤔 设计决策记录

### 为什么选择BepInEx而非传统Modding API？

1. **成熟度**: BepInEx是Unity游戏最成熟的Mod框架
2. **社区支持**: 广泛使用，文档完善
3. **无需修改游戏**: 不需要替换Assembly
4. **易于维护**: Mod独立于游戏更新
5. **跨游戏经验**: 很多开发者已熟悉BepInEx

### 为什么保留Disabled目录？

虽然BepInEx有自己的禁用机制（文件名添加`.disabled`），但我们使用独立的`_Disabled`文件夹因为：
1. 更直观的管理
2. 方便批量操作
3. 与UI状态更好同步
4. 避免修改Mod文件本身

### 配色选择暗红色系？

1. 契合Hornet的角色定位（红色丝线）
2. 与原作橙色主题有所区分
3. 暗红色更显神秘和优雅
4. 符合"蛹"的命名主题

---

## 📞 需要帮助？

### 资源

- **Avalonia文档**: https://docs.avaloniaui.net/
- **BepInEx文档**: https://docs.bepinex.dev/
- **原Scarab仓库**: https://github.com/fifty-six/Scarab

### 社区

- **空洞骑士Modding Discord**: https://discord.gg/hollowknight
- **BepInEx Discord**: https://discord.gg/MpFEDAg

### 联系方式

- 项目Issues: [待创建]
- 开发者: [你的联系方式]

---

## 🎉 致谢

感谢以下项目和个人：

- **fifty-six** - Scarab原作者
- **Team Cherry** - 空洞骑士系列创作者
- **BepInEx团队** - Mod框架开发者
- **Avalonia团队** - UI框架
- **空洞骑士Modding社区** - 经验分享

---

**最后更新**: 2024-XX-XX  
**项目状态**: 开发中 🚧  
**下一个里程碑**: 创建应用图标和UI资源

---

*继续前进，破茧成蝶！🦋*
